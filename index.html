<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Swissbotanics Store 🌿</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .product {
            border: 1px solid #e0e0e0;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
        }

            .product img {
                max-width: 200px;
                height: auto;
            }

        button {
            background: #2d882d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

            button:hover {
                background: #1a611a;
            }
    </style>
</head>
<body>
    <h1>Swissbotanics Natural Products 🇨🇭</h1>
    <div id="loading">Loading botanical products...</div>
    <div id="products"></div>

    <script>
    const shopDomain = 'swissbotanics.myshopify.com';
    const stripeKey = 'pk_test_your_stripe_key'; // Replace with your key

    async function loadProducts() {
      try {
        const authResponse = await fetch(`/api/auth?shop=${shopDomain}`);
        if (!authResponse.ok) throw new Error('Auth failed');

        const productsResponse = await fetch(`/api/products?shop=${shopDomain}`);
        const products = await productsResponse.json();

        const container = document.getElementById('products');
        container.innerHTML = '';

        products.forEach(product => {
          const productDiv = document.createElement('div');
          productDiv.className = 'product';
          productDiv.innerHTML = `
            <h2>${product.title}</h2>
            ${product.images[0] ? `<img src="${product.images[0].src}" alt="${product.title}">` : ''}
            <p>${product.body_html || 'Natural Swiss botanical product'}</p>
            <p>Price: CHF ${product.variants[0].price}</p>
            <button onclick="startCheckout('${product.id}')">Purchase with Klarna</button>
          `;
          container.appendChild(productDiv);
        });

        document.getElementById('loading').style.display = 'none';
      } catch (error) {
        document.getElementById('loading').innerHTML =
          'Error loading products. Please refresh or contact support.';
      }
    }

    async function startCheckout(productId) {
      try {
        const product = await fetch(`/api/products?shop=${shopDomain}`)
          .then(res => res.json())
          .then(products => products.find(p => p.id === productId));

        const response = await fetch('/api/create-checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            items: [{
              title: product.title,
              price: product.variants[0].price,
              image: product.images[0]?.src,
              quantity: 1
            }]
          })
        });

        const { id } = await response.json();
        const stripe = Stripe(stripeKey);
        await stripe.redirectToCheckout({ sessionId: id });
      } catch (error) {
        alert('Error starting checkout: ' + error.message);
      }
    }

    // Initial load
    loadProducts();
    </script>
</body>
</html>